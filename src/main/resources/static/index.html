<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>应用管理</title>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <style>
        .app-icon {
            width: 32px;
            height: 32px;
            border-radius: 4px;
            object-fit: cover;
        }

        .el-table .el-button {
            margin-right: 6px;
        }

        body {
            background: #f5f6fa;
        }

        [v-cloak] {
            display: none !important;
        }
    </style>
</head>

<body>
    <div id="app" v-cloak>
        <el-header height="56px"
            style="background:#2d8cf0;color:#fff;display:flex;align-items:center;font-size:20px;font-weight:bold;">
            <span style="margin-left:20px;">SSO认证中心管理</span>
        </el-header>
        <el-container>
            <el-aside width="200px">
                <el-menu :default-active="activeMenu" @select="handleMenuSelect">
                    <el-menu-item index="my-apps">我的应用</el-menu-item>
                    <el-menu-item index="app-manage">应用管理</el-menu-item>
                    <el-menu-item index="role-manage">角色管理</el-menu-item>
                    <el-menu-item index="user-manage">用户管理</el-menu-item>
                </el-menu>
            </el-aside>
            <el-main>
                <div v-if="activeMenu==='app-manage'">
                    <el-row justify="end" class="mb-2">
                        <el-button type="primary" @click="openAppModal()">添加应用</el-button>
                        <el-button @click="fetchAppList">刷新</el-button>
                    </el-row>
                    <el-table :data="appList" style="width: 100%">
                        <el-table-column prop="appName" label="应用名称" />
                        <el-table-column prop="clientId" label="应用ID" />
                        <el-table-column prop="appUrl" label="应用地址">
                            <template #default="scope">
                                <a v-if="scope && scope.row && scope.row.appUrl" :href="scope.row.appUrl"
                                    target="_blank">访问</a>
                            </template>
                        </el-table-column>
                        <el-table-column prop="appIcon" label="应用图标">
                            <template #default="scope">
                                <img v-if="scope && scope.row && scope.row.appIcon" :src="scope.row.appIcon"
                                    class="app-icon" />
                            </template>
                        </el-table-column>
                        <el-table-column prop="protocol" label="认证协议" />
                        <el-table-column prop="createTime" label="创建时间" />
                        <el-table-column label="操作" width="220">
                            <template #default="scope">
                                <el-button size="small" @click="openAppModal(scope && scope.row)">编辑</el-button>
                                <el-button size="small" @click="openGrantModal(scope && scope.row)">授权</el-button>
                                <el-button size="small" type="danger"
                                    @click="deleteApp(scope && scope.row)">删除</el-button>
                            </template>
                        </el-table-column>
                    </el-table>
                </div>
                <div v-if="activeMenu==='role-manage'">
                    <el-row justify="end" class="mb-2">
                        <el-button type="primary" @click="openRoleModal()">添加角色</el-button>
                    </el-row>
                    <el-table :data="roleList" style="width: 100%"
                        :header-cell-style="{padding: '6px 8px', fontWeight: 'bold'}">
                        <el-table-column prop="roleName" label="角色名称" />
                        <el-table-column prop="roleDesc" label="描述" />
                        <el-table-column prop="createTime" label="创建时间" />
                        <el-table-column label="操作" width="220" :align="'left'">
                            <template #default="scope">
                                <div style="white-space:normal;display:flex;flex-wrap:wrap;gap:6px 0;">
                                    <el-button size="small" style="margin-right:6px;"
                                        @click="editRole(scope && scope.row)">编辑</el-button>
                                    <el-button size="small" type="primary" style="margin-right:6px;"
                                        @click="openBindUserModal(scope && scope.row)">绑定用户</el-button>
                                    <el-button size="small" type="danger" plain
                                        style="margin-right:0;border:1px solid #f56c6c;"
                                        @click="deleteRole(scope && scope.row)">删除</el-button>
                                </div>
                            </template>
                        </el-table-column>
                    </el-table>
                </div>
                <div v-if="activeMenu==='user-manage'">
                    <el-row justify="end" class="mb-2">
                        <el-button type="primary" @click="openUserModal()">添加用户</el-button>
                    </el-row>
                    <el-table :data="userList" style="width: 100%"
                        :header-cell-style="{padding: '6px 8px', fontWeight: 'bold'}">
                        <el-table-column prop="username" label="用户名" />
                        <el-table-column prop="nickname" label="昵称" />
                        <el-table-column prop="createTime" label="创建时间" />
                        <el-table-column label="操作" width="180" :align="'left'">
                            <template #default="scope">
                                <div style="white-space:normal;display:flex;flex-wrap:wrap;gap:6px 0;">
                                    <el-button size="small" style="margin-right:6px;"
                                        @click="editUser(scope && scope.row)">编辑</el-button>
                                    <el-button size="small" type="danger" plain
                                        style="margin-right:0;border:1px solid #f56c6c;"
                                        @click="deleteUser(scope && scope.row)">删除</el-button>
                                </div>
                            </template>
                        </el-table-column>
                    </el-table>
                </div>
                <div v-if="activeMenu==='my-apps'">
                    <el-table :data="myAppList" style="width: 100%">
                        <el-table-column prop="appName" label="应用名称" />
                        <el-table-column prop="clientId" label="应用ID" />
                        <el-table-column label="操作" width="120">
                            <template #default="scope">
                                <el-button size="small" @click="openGrantModal(scope && scope.row)">授权</el-button>
                            </template>
                        </el-table-column>
                    </el-table>
                </div>
            </el-main>
        </el-container>
        <el-dialog v-model="appModalVisible" :title="editingApp ? '编辑应用' : '添加应用'">
            <el-form :model="appForm" label-width="90px">
                <el-form-item label="应用名称"><el-input v-model="appForm.appName" /></el-form-item>
                <el-form-item label="应用ID"><el-input v-model="appForm.clientId" /></el-form-item>
                <el-form-item label="应用地址"><el-input v-model="appForm.appUrl" /></el-form-item>
                <el-form-item label="应用图标URL"><el-input v-model="appForm.appIcon" /></el-form-item>
                <el-form-item label="认证协议">
                    <el-select v-model="appForm.protocol">
                        <el-option label="OAuth 2.0" value="OAuth 2.0" />
                        <el-option label="SAML" value="SAML" />
                        <el-option label="OpenID Connect" value="OpenID Connect" />
                    </el-select>
                </el-form-item>
            </el-form>
            <template #footer>
                <el-button @click="appModalVisible=false">取消</el-button>
                <el-button type="primary" @click="saveApp">保存</el-button>
            </template>
        </el-dialog>
        <el-dialog v-model="grantModalVisible" title="角色授权">
            <el-checkbox-group v-model="checkedRoles">
                <el-checkbox v-for="role in allRoles" :key="role.id" :label="role.id">{{ role.roleName }}</el-checkbox>
            </el-checkbox-group>
            <template #footer>
                <el-button @click="grantModalVisible=false">关闭</el-button>
            </template>
        </el-dialog>
        <el-dialog v-model="roleModalVisible" :title="editingRole ? '编辑角色' : '添加角色'">
            <el-form :model="roleForm" label-width="90px">
                <el-form-item label="角色名称"><el-input v-model="roleForm.roleName" /></el-form-item>
                <el-form-item label="描述"><el-input v-model="roleForm.roleDesc" /></el-form-item>
            </el-form>
            <template #footer>
                <el-button @click="roleModalVisible=false">取消</el-button>
                <el-button type="primary" @click="saveRole">保存</el-button>
            </template>
        </el-dialog>
        <el-dialog v-model="userModalVisible" :title="editingUser ? '编辑用户' : '添加用户'">
            <el-form :model="userForm" label-width="90px">
                <el-form-item label="用户名"><el-input v-model="userForm.username" /></el-form-item>
                <el-form-item label="昵称"><el-input v-model="userForm.nickname" /></el-form-item>
                <el-form-item label="密码" v-if="!editingUser"><el-input v-model="userForm.password"
                        type="password" /></el-form-item>
            </el-form>
            <template #footer>
                <el-button @click="userModalVisible=false">取消</el-button>
                <el-button type="primary" @click="saveUser">保存</el-button>
            </template>
        </el-dialog>
        <el-dialog v-model="bindUserModalVisible" title="绑定用户">
            <el-checkbox-group v-model="checkedUserIds">
                <el-checkbox v-for="user in allUsers" :key="user.id" :label="user.id">{{ user.username }} <span
                        style="color:#888">{{ user.nickname }}</span></el-checkbox>
            </el-checkbox-group>
            <template #footer>
                <el-button @click="bindUserModalVisible=false">关闭</el-button>
            </template>
        </el-dialog>
    </div>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/element-plus/dist/index.full.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        const { createApp, ref, reactive, onMounted, watch } = Vue;

        const App = {
            template: `
        <el-container>
          <el-aside width="200px">
            <el-menu :default-active="activeMenu" @select="handleMenuSelect">
              <el-menu-item index="my-apps">我的应用</el-menu-item>
              <el-menu-item index="app-manage">应用管理</el-menu-item>
              <el-menu-item index="role-manage">角色管理</el-menu-item>
              <el-menu-item index="user-manage">用户管理</el-menu-item>
            </el-menu>
          </el-aside>
          <el-main>
            <div v-if="activeMenu==='app-manage'">
              <el-row justify="end" class="mb-2">
                <el-button type="primary" @click="openAppModal()">添加应用</el-button>
                <el-button @click="fetchAppList">刷新</el-button>
              </el-row>
              <el-table :data="appList" style="width: 100%">
                <el-table-column prop="appName" label="应用名称" />
                <el-table-column prop="clientId" label="应用ID" />
                <el-table-column prop="appUrl" label="应用地址">
                  <template #default="scope">
                    <a v-if="scope && scope.row && scope.row.appUrl" :href="scope.row.appUrl" target="_blank">访问</a>
                  </template>
                </el-table-column>
                <el-table-column prop="appIcon" label="应用图标">
                  <template #default="scope">
                    <img v-if="scope && scope.row && scope.row.appIcon" :src="scope.row.appIcon" class="app-icon" />
                  </template>
                </el-table-column>
                <el-table-column prop="protocol" label="认证协议" />
                <el-table-column prop="createTime" label="创建时间" />
                <el-table-column label="操作" width="220">
                  <template #default="scope">
                    <el-button size="small" @click="openAppModal(scope && scope.row)">编辑</el-button>
                    <el-button size="small" @click="openGrantModal(scope && scope.row)">授权</el-button>
                    <el-button size="small" type="danger" @click="deleteApp(scope && scope.row)">删除</el-button>
                  </template>
                </el-table-column>
              </el-table>
            </div>
            <div v-if="activeMenu==='role-manage'">
              <el-row justify="end" class="mb-2">
                <el-button type="primary" @click="openRoleModal()">添加角色</el-button>
              </el-row>
              <el-table :data="roleList" style="width: 100%" :header-cell-style="{padding: '6px 8px', fontWeight: 'bold'}">
                <el-table-column prop="roleName" label="角色名称" />
                <el-table-column prop="roleDesc" label="描述" />
                <el-table-column prop="createTime" label="创建时间" />
                <el-table-column label="操作" width="220" :align="'left'">
                  <template #default="scope">
                    <div style="white-space:normal;display:flex;flex-wrap:wrap;gap:6px 0;">
                      <el-button size="small" style="margin-right:6px;" @click="editRole(scope && scope.row)">编辑</el-button>
                      <el-button size="small" type="primary" style="margin-right:6px;" @click="openBindUserModal(scope && scope.row)">绑定用户</el-button>
                      <el-button size="small" type="danger" plain style="margin-right:0;border:1px solid #f56c6c;" @click="deleteRole(scope && scope.row)">删除</el-button>
                    </div>
                  </template>
                </el-table-column>
              </el-table>
            </div>
            <div v-if="activeMenu==='user-manage'">
              <el-row justify="end" class="mb-2">
                <el-button type="primary" @click="openUserModal()">添加用户</el-button>
              </el-row>
              <el-table :data="userList" style="width: 100%" :header-cell-style="{padding: '6px 8px', fontWeight: 'bold'}">
                <el-table-column prop="username" label="用户名" />
                <el-table-column prop="nickname" label="昵称" />
                <el-table-column prop="createTime" label="创建时间" />
                <el-table-column label="操作" width="180" :align="'left'">
                  <template #default="scope">
                    <div style="white-space:normal;display:flex;flex-wrap:wrap;gap:6px 0;">
                      <el-button size="small" style="margin-right:6px;" @click="editUser(scope && scope.row)">编辑</el-button>
                      <el-button size="small" type="danger" plain style="margin-right:0;border:1px solid #f56c6c;" @click="deleteUser(scope && scope.row)">删除</el-button>
                    </div>
                  </template>
                </el-table-column>
              </el-table>
            </div>
            <div v-if="activeMenu==='my-apps'">
              <el-table :data="myAppList" style="width: 100%">
                <el-table-column prop="appName" label="应用名称" />
                <el-table-column prop="clientId" label="应用ID" />
                <el-table-column label="操作" width="120">
                  <template #default="scope">
                    <el-button size="small" @click="openGrantModal(scope && scope.row)">授权</el-button>
                  </template>
                </el-table-column>
              </el-table>
            </div>
          </el-main>
        </el-container>
        <el-dialog v-model="appModalVisible" :title="editingApp ? '编辑应用' : '添加应用'">
          <el-form :model="appForm" label-width="90px">
            <el-form-item label="应用名称"><el-input v-model="appForm.appName" /></el-form-item>
            <el-form-item label="应用ID"><el-input v-model="appForm.clientId" /></el-form-item>
            <el-form-item label="应用地址"><el-input v-model="appForm.appUrl" /></el-form-item>
            <el-form-item label="应用图标URL"><el-input v-model="appForm.appIcon" /></el-form-item>
            <el-form-item label="认证协议">
              <el-select v-model="appForm.protocol">
                <el-option label="OAuth 2.0" value="OAuth 2.0" />
                <el-option label="SAML" value="SAML" />
                <el-option label="OpenID Connect" value="OpenID Connect" />
              </el-select>
            </el-form-item>
          </el-form>
          <template #footer>
            <el-button @click="appModalVisible=false">取消</el-button>
            <el-button type="primary" @click="saveApp">保存</el-button>
          </template>
        </el-dialog>
        <el-dialog v-model="grantModalVisible" title="角色授权">
          <el-checkbox-group v-model="checkedRoles">
            <el-checkbox v-for="role in allRoles" :key="role.id" :label="role.id">{{ role.roleName }}</el-checkbox>
          </el-checkbox-group>
          <template #footer>
            <el-button @click="grantModalVisible=false">关闭</el-button>
          </template>
        </el-dialog>
        <el-dialog v-model="roleModalVisible" :title="editingRole ? '编辑角色' : '添加角色'">
          <el-form :model="roleForm" label-width="90px">
            <el-form-item label="角色名称"><el-input v-model="roleForm.roleName" /></el-form-item>
            <el-form-item label="描述"><el-input v-model="roleForm.roleDesc" /></el-form-item>
          </el-form>
          <template #footer>
            <el-button @click="roleModalVisible=false">取消</el-button>
            <el-button type="primary" @click="saveRole">保存</el-button>
          </template>
        </el-dialog>
        <el-dialog v-model="userModalVisible" :title="editingUser ? '编辑用户' : '添加用户'">
          <el-form :model="userForm" label-width="90px">
            <el-form-item label="用户名"><el-input v-model="userForm.username" /></el-form-item>
            <el-form-item label="昵称"><el-input v-model="userForm.nickname" /></el-form-item>
            <el-form-item label="密码" v-if="!editingUser"><el-input v-model="userForm.password" type="password" /></el-form-item>
          </el-form>
          <template #footer>
            <el-button @click="userModalVisible=false">取消</el-button>
            <el-button type="primary" @click="saveUser">保存</el-button>
          </template>
        </el-dialog>
        <el-dialog v-model="bindUserModalVisible" title="绑定用户">
          <el-checkbox-group v-model="checkedUserIds">
            <el-checkbox v-for="user in allUsers" :key="user.id" :label="user.id">{{ user.username }} <span style="color:#888">{{ user.nickname }}</span></el-checkbox>
          </el-checkbox-group>
          <template #footer>
            <el-button @click="bindUserModalVisible=false">关闭</el-button>
          </template>
        </el-dialog>
      `,
            setup() {
                const activeMenu = ref('app-manage');
                const appList = ref([]);
                const roleList = ref([]);
                const userList = ref([]);
                const appModalVisible = ref(false);
                const grantModalVisible = ref(false);
                const editingApp = ref(null);
                const appForm = reactive({ appName: '', clientId: '', appUrl: '', appIcon: '', protocol: '' });
                const allRoles = ref([]);
                const checkedRoles = ref([]);
                const grantAppId = ref(null);
                const roleModalVisible = ref(false);
                const editingRole = ref(null);
                const roleForm = reactive({ roleName: '', roleDesc: '' });
                const userModalVisible = ref(false);
                const editingUser = ref(null);
                const userForm = reactive({ username: '', nickname: '', password: '' });
                const bindUserModalVisible = ref(false);
                const allUsers = ref([]);
                const checkedUserIds = ref([]);
                const bindRoleId = ref(null);
                const myAppList = ref([]);

                const menuHashMap = {
                    'my-apps': '/my-apps',
                    'app-manage': '/app-manage',
                    'role-manage': '/role-manage',
                    'user-manage': '/user-manage'
                };
                const hashMenuMap = {
                    '/my-apps': 'my-apps',
                    '/app-manage': 'app-manage',
                    '/role-manage': 'role-manage',
                    '/user-manage': 'user-manage'
                };

                const fetchAppList = async () => {
                    const res = await axios.get('/api/client/list');
                    appList.value = res.data.data || [];
                };

                const fetchRoleList = async () => {
                    const res = await axios.get('/api/role/list');
                    roleList.value = res.data.data || [];
                };

                const fetchUserList = async () => {
                    const res = await axios.get('/api/user/list');
                    userList.value = res.data.data || [];
                };

                const fetchMyAppList = async () => {
                    const res = await axios.get('/api/client/my');
                    myAppList.value = res.data.data || [];
                };

                const openAppModal = (row) => {
                    if (row) {
                        Object.assign(appForm, row);
                        editingApp.value = row;
                    } else {
                        Object.assign(appForm, { appName: '', clientId: '', appUrl: '', appIcon: '', protocol: '' });
                        editingApp.value = null;
                    }
                    appModalVisible.value = true;
                };

                const saveApp = async () => {
                    if (editingApp.value) {
                        await axios.post('/api/client/update', appForm);
                    } else {
                        await axios.post('/api/client/add', appForm);
                    }
                    appModalVisible.value = false;
                    fetchAppList();
                };

                const openGrantModal = async (row) => {
                    if (!row || !row.id) return;
                    grantAppId.value = row.id;
                    const roleRes = await axios.get('/api/role/list');
                    allRoles.value = roleRes.data.data || [];
                    const grantedRes = await axios.get('/api/roleApp/list', { params: { clientId: row.id } });
                    checkedRoles.value = (grantedRes.data.data || []).map(r => r.id);
                    grantModalVisible.value = true;
                };

                const deleteApp = async (row) => {
                    if (!row) return;
                    await axios.post(`/api/client/delete/${row.id}`);
                    fetchAppList();
                    ElementPlus.ElMessage.success('删除成功');
                };

                const editRole = (row) => {
                    if (row) {
                        Object.assign(roleForm, row);
                        editingRole.value = row;
                    } else {
                        Object.assign(roleForm, { roleName: '', roleDesc: '' });
                        editingRole.value = null;
                    }
                    roleModalVisible.value = true;
                };

                const saveRole = async () => {
                    if (editingRole.value) {
                        await axios.post('/api/role/update', { id: editingRole.value.id, ...roleForm });
                    } else {
                        await axios.post('/api/role/add', roleForm);
                    }
                    roleModalVisible.value = false;
                    fetchRoleList();
                    ElementPlus.ElMessage.success('保存成功');
                };

                const deleteRole = async (row) => {
                    if (!row) return;
                    await axios.post(`/api/role/delete/${row.id}`);
                    fetchRoleList();
                    ElementPlus.ElMessage.success('删除成功');
                };

                const editUser = (row) => {
                    if (row) {
                        Object.assign(userForm, row);
                        userForm.password = '';
                        editingUser.value = row;
                    } else {
                        Object.assign(userForm, { username: '', nickname: '', password: '' });
                        editingUser.value = null;
                    }
                    userModalVisible.value = true;
                };

                const saveUser = async () => {
                    if (editingUser.value) {
                        const data = { id: editingUser.value.id, username: userForm.username, nickname: userForm.nickname };
                        if (userForm.password) data.password = userForm.password;
                        await axios.post('/api/user/update', data);
                    } else {
                        await axios.post('/api/user/add', userForm);
                    }
                    userModalVisible.value = false;
                    fetchUserList();
                    ElementPlus.ElMessage.success('保存成功');
                };

                const deleteUser = async (row) => {
                    if (!row) return;
                    await axios.post(`/api/user/delete/${row.id}`);
                    fetchUserList();
                    ElementPlus.ElMessage.success('删除成功');
                };

                const openBindUserModal = async (role) => {
                    if (!role) return;
                    bindRoleId.value = role.id;
                    const userRes = await axios.get('/api/user/list');
                    allUsers.value = userRes.data.data || [];
                    const checkedRes = await axios.get(`/api/user-role/list?roleId=${role.id}`);
                    checkedUserIds.value = (checkedRes.data.data || []).map(u => u.id);
                    bindUserModalVisible.value = true;
                };

                const openUserModal = () => {
                    userForm.username = '';
                    userForm.nickname = '';
                    userForm.password = '';
                    editingUser.value = null;
                    userModalVisible.value = true;
                };

                const openRoleModal = () => {
                    roleForm.roleName = '';
                    roleForm.roleDesc = '';
                    editingRole.value = null;
                    roleModalVisible.value = true;
                };

                watch(checkedUserIds, async (newVal, oldVal) => {
                    if (!bindRoleId.value) return;
                    for (const id of newVal) {
                        if (!oldVal.includes(id)) {
                            await axios.post('/api/user-role/add', { userId: id, roleId: bindRoleId.value });
                        }
                    }
                    for (const id of oldVal) {
                        if (!newVal.includes(id)) {
                            await axios.post('/api/user-role/delete', { userId: id, roleId: bindRoleId.value });
                        }
                    }
                });

                const setMenuByHash = () => {
                    const hash = location.hash.replace('#', '') || '/app-manage';
                    const menu = hashMenuMap[hash] || 'app-manage';
                    activeMenu.value = menu;
                    if (menu === 'app-manage') fetchAppList();
                    if (menu === 'role-manage') fetchRoleList();
                    if (menu === 'user-manage') fetchUserList();
                    if (menu === 'my-apps') fetchMyAppList();
                };

                // hash 变化监听
                window.addEventListener('hashchange', setMenuByHash);
                // 页面加载时
                onMounted(() => {
                    setMenuByHash();
                });
                // 菜单点击时切换 hash
                const handleMenuSelect = (key) => {
                    location.hash = menuHashMap[key] || '/app-manage';
                };

                return {
                    activeMenu, appList, roleList, userList, appModalVisible, grantModalVisible, appForm, editingApp,
                    openAppModal, saveApp, fetchAppList, fetchRoleList, fetchUserList, allRoles, checkedRoles, handleMenuSelect,
                    deleteApp, deleteRole, deleteUser,
                    roleModalVisible, editingRole, roleForm, saveRole,
                    userModalVisible, editingUser, userForm, saveUser,
                    editRole, editUser,
                    bindUserModalVisible, allUsers, checkedUserIds, openBindUserModal, openUserModal, openRoleModal,
                    myAppList, fetchMyAppList,
                    openGrantModal, grantAppId, allRoles, checkedRoles, grantModalVisible
                };
            }
        };

        // 1. 登录成功后自动从URL参数获取token并存储到localStorage
        function getQueryParam(name) {
            const match = window.location.search.match(new RegExp('[?&]' + name + '=([^&]*)'));
            return match ? decodeURIComponent(match[1]) : null;
        }
        const token = getQueryParam('token');
        if (token) {
            console.log('[SSO] URL参数token:', token);
            localStorage.setItem('token', token);
            const url = new URL(window.location);
            url.searchParams.delete('token');
            window.history.replaceState({}, document.title, url.pathname + url.search);
        }
        // 检查 token，如果没有则跳转 SSO
        (function checkLoginAndRedirectSSO() {
            const urlToken = getQueryParam('token');
            const localToken = localStorage.getItem('token');
            console.log('[SSO] localStorage token:', localToken, 'URL token:', urlToken);
            if (!localToken && !urlToken) {
                const currentUrl = encodeURIComponent(window.location.href);
                console.log('[SSO] 未检测到token，跳转SSO登录', currentUrl);
                window.location.href = '/oauth2/login.html?redirect=' + currentUrl;
            }
        })();
        // 2. axios请求自动携带token
        axios.interceptors.request.use(config => {
            const token = localStorage.getItem('token');
            console.log('[SSO] axios请求携带token:', token, config.url);
            if (token) {
                config.headers['Authorization'] = 'Bearer ' + token;
            }
            return config;
        });
        // 响应拦截：如被重定向到login.html则跳转登录页
        axios.interceptors.response.use(
            function (response) {
                if (typeof response.data === 'string' && response.data.indexOf('统一身份认证') !== -1) {
                    window.location.href = '/oauth2/login.html';
                    return Promise.reject(new Error('未登录，已跳转登录页'));
                }
                return response;
            },
            function (error) {
                return Promise.reject(error);
            }
        );

        const app = createApp(App);
        app.use(ElementPlus);
        app.mount('#app');
    </script>
</body>

</html>